# GitHub Actions workflow for uptime monitoring
name: Uptime Monitor

on:
  # Run every 6 hours
  schedule:
    - cron: '0 */6 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  uptime-check:
    name: Check Site Uptime
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check site availability
        id: site_check
        run: |
          URL="https://hasintha01.github.io"
          START=$(date +%s%3N)
          RESPONSE=$(curl -o /dev/null -s -w "%{http_code}|%{time_total}" -L $URL)
          END=$(date +%s%3N)
          
          HTTP_CODE=$(echo $RESPONSE | cut -d'|' -f1)
          RESPONSE_TIME=$(echo $RESPONSE | cut -d'|' -f2)
          RESPONSE_TIME_MS=$(echo "$RESPONSE_TIME * 1000" | bc)
          
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response_time=$RESPONSE_TIME_MS" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
          echo "status=$( [ $HTTP_CODE -eq 200 ] && echo 'up' || echo 'down' )" >> $GITHUB_OUTPUT
          
          echo "Site Status: $HTTP_CODE"
          echo "Response Time: ${RESPONSE_TIME_MS}ms"
      
      - name: Update uptime log
        run: |
          mkdir -p .monitoring
          echo "$(date -u +"%Y-%m-%d %H:%M:%S UTC"),${{ steps.site_check.outputs.status }},${{ steps.site_check.outputs.http_code }},${{ steps.site_check.outputs.response_time }}" >> .monitoring/uptime.log
          
          # Keep only last 500 entries
          tail -n 500 .monitoring/uptime.log > .monitoring/uptime.log.tmp
          mv .monitoring/uptime.log.tmp .monitoring/uptime.log
      
      - name: Calculate uptime percentage
        id: uptime_calc
        run: |
          if [ -f .monitoring/uptime.log ]; then
            TOTAL=$(wc -l < .monitoring/uptime.log)
            UP=$(grep -c ",up," .monitoring/uptime.log || echo 0)
            UPTIME=$(echo "scale=2; $UP * 100 / $TOTAL" | bc)
            echo "uptime_percentage=$UPTIME" >> $GITHUB_OUTPUT
            echo "total_checks=$TOTAL" >> $GITHUB_OUTPUT
            echo "successful_checks=$UP" >> $GITHUB_OUTPUT
            echo "Uptime: ${UPTIME}%"
          else
            echo "uptime_percentage=100.00" >> $GITHUB_OUTPUT
            echo "total_checks=0" >> $GITHUB_OUTPUT
            echo "successful_checks=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate uptime report
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          STATUS="${{ steps.site_check.outputs.status }}"
          HTTP_CODE="${{ steps.site_check.outputs.http_code }}"
          RESPONSE_TIME="${{ steps.site_check.outputs.response_time }}"
          UPTIME="${{ steps.uptime_calc.outputs.uptime_percentage }}"
          TOTAL="${{ steps.uptime_calc.outputs.total_checks }}"
          SUCCESSFUL="${{ steps.uptime_calc.outputs.successful_checks }}"
          FAILED=$((TOTAL - SUCCESSFUL))
          
          cat << EOF > .monitoring/uptime-report.md
          # Uptime Monitoring Report

          ## Current Status

          **Site:** https://hasintha01.github.io  
          **Status:** ${STATUS^^}  
          **Last Check:** $TIMESTAMP

          | Metric | Value | Status |
          |--------|-------|--------|
          | HTTP Status | $HTTP_CODE OK | HEALTHY |
          | Current Response Time | ${RESPONSE_TIME}ms | GOOD |
          | Uptime (All Time) | ${UPTIME}% | EXCELLENT |
          | Total Checks | $TOTAL | - |
          | Failed Checks | $FAILED | PERFECT |

          ## Reliability Statistics

          ### Uptime History

          | Period | Uptime | Checks | Failures |
          |--------|--------|--------|----------|
          | All time | ${UPTIME}% | $TOTAL | $FAILED |

          ## Monitoring Details

          - **Check Frequency:** Every 6 hours
          - **Method:** HTTP GET request
          - **Success Criteria:** HTTP 200 status code
          - **Alert Threshold:** HTTP code != 200
          - **Data Retention:** Last 500 checks

          ## Next Check
          Scheduled in approximately 6 hours

          ---

          *This report is automatically generated by the uptime monitor workflow*  
          *Data source: .monitoring/uptime.log*  
          *Last updated: $TIMESTAMP*
          EOF
      
      - name: Commit uptime log
        if: steps.site_check.outputs.status == 'up'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .monitoring/uptime.log .monitoring/uptime-report.md
          git diff --quiet && git diff --staged --quiet || {
            git commit -m "Update uptime log - ${{ steps.site_check.outputs.timestamp }}"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
          }
      
      - name: Create issue if site is down
        if: steps.site_check.outputs.status == 'down'
        uses: actions/github-script@v7
        with:
          script: |
            const httpCode = '${{ steps.site_check.outputs.http_code }}';
            const timestamp = '${{ steps.site_check.outputs.timestamp }}';
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[ALERT] Site Down: HTTP ${httpCode}`,
              body: `## Site Availability Alert\n\n` +
                    `**Status:** DOWN\n` +
                    `**URL:** https://hasintha01.github.io\n` +
                    `**HTTP Code:** ${httpCode}\n` +
                    `**Time:** ${timestamp}\n\n` +
                    `The site is currently unreachable. Please investigate immediately.\n\n` +
                    `---\n*This issue was automatically created by the uptime monitor.*`,
              labels: ['bug', 'monitoring', 'urgent']
            });
      
      - name: Update status summary
        if: always()
        run: |
          echo "## Site Uptime Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://hasintha01.github.io" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.site_check.outputs.status == 'up' && 'UP' || 'DOWN' }}" >> $GITHUB_STEP_SUMMARY
          echo "**HTTP Code:** ${{ steps.site_check.outputs.http_code }}" >> $GITHUB_STEP_SUMMARY
          echo "**Response Time:** ${{ steps.site_check.outputs.response_time }}ms" >> $GITHUB_STEP_SUMMARY
          echo "**Checked:** ${{ steps.site_check.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "**Uptime:** ${{ steps.uptime_calc.outputs.uptime_percentage }}%" >> $GITHUB_STEP_SUMMARY
